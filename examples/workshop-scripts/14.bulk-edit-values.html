<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
</head>

<body>
    <script src="../../cascade-restapi.js"></script>
    <script>
        // if you change the value of data definition field option, it does NOT auto update on pages or blocks.
        // for example, if you have a College drop down for your news posts and a college changes it's name
        // the best way to get all pages using that drop down updated is to ADD the new college name along side the old name
        // and then use web services to update all pages with the new values

        // ONLY run the following AFTER adding the new college along side the old college name
        // in this example, it's a custom metadata dropdown field

        var oldCollege = "College of Computing";
        var newCollege = "College of Engineering";
        var blocks = [];

        // we know we have to update a value in custom metadata
        // this metadata set is attached to pages via content type
        // lets get all news pages with content type "Post"

        // updateMetadata();

        // updateContent();

        function updateMetadata() {
            listSubscribers({
                type: "contenttype",
                id: "aeeb3e780a0000c954bf54679212cf6c", // fill in
            }).then(function(result) {
                console.log(result);
                var pages = result.apiReturn.subscribers; // Note: drill down to the array of children in the folder
                pages.forEach(function(page) {
                    console.log(page);
                    if (page.type == "page") { // although only pages come up for this contenttype, it doesn't hurt to throw in a check just in case
                        readAsset({
                            type: "page",
                            id: page.id,
                        }).then(function(result) {
                            console.log(result);
                            var customMetadata = result.apiReturn.asset.page.metadata.dynamicFields;
                            var collegeField = customMetadata[1].fieldValues[0];
                            // again, all structuredData nodes are arrays of objects, even if there's only one object at the time
                            // console.log(collegeField);
                            if (collegeField.value == oldCollege) { // check if college is old college 
                                collegeField.value = newCollege; // if so, replace with new college and update the page
                                editAsset({
                                    asset: result.apiReturn,
                                }).then(function(result) {
                                    console.log(result);
                                }).catch(function(error) {
                                    console.log(error);
                                });
                            }
                        }).catch(function(error) {
                            console.log(error);
                        });
                    }
                });
            }).catch(function(error) {
                console.log(error);
            });
        }

        // looks like the old College name is used in Post content
        // BRICKS would've been great here but its ok, web services to the rescue 

        function updateContent() {
            listSubscribers({
                type: "contenttype",
                id: "aeeb3e780a0000c954bf54679212cf6c", // fill in
            }).then(function(result) {
                // console.log(result);
                var pages = result.apiReturn.subscribers;
                pages.forEach(function(page) {
                    console.log(page);
                    if (page.type == "page") {
                        readAsset({
                            type: "page",
                            id: page.id,
                        }).then(function(result) {
                            var updatedRows = false;
                            console.log(result);
                            var structuredDataNodes = result.apiReturn.asset.page.structuredData.structuredDataNodes;
                            // since we have multiple structure data nodes (data definition field group)
                            // we'll want to loop over each node to ensure we're tackling the correct one
                            structuredDataNodes.forEach(function(node) {
                                console.log(node); // familiarize yourself with the node structure
                                if (node.type == "group" && node.identifier == "row") { // we know the node we're looking for is a group and content can only be in a "row" node
                                    // inside the the "row" node, positions don't change so we know:
                                    var rowType = node.structuredDataNodes[0];
                                    var rowBlock = node.structuredDataNodes[1];
                                    var rowContent = node.structuredDataNodes[2];
                                    // we can find the college name in both content and/or block content, so we'll have to check both on each row
                                    if (rowType.text && rowType.text.includes("Block")) { // text property only exists if it has a value, so you'll want to check if it exists before checking the value
                                        // console.log(node);
                                        var rowBlockID = rowBlock.blockId;
                                        // since the same block can be attached to multiple pages, lets make sure we're only dealing with unique blocks
                                        if (!blocks.includes(rowBlockID)) {
                                            blocks.push(rowBlockID); // add unique block to array for checking later                                            
                                            // read the block to check the block content
                                            readAsset({
                                                type: "block",
                                                id: rowBlockID,
                                            }).then(function(result) {
                                                console.log(result);
                                                var blockContent = result.apiReturn.asset.xhtmlDataDefinitionBlock.structuredData.structuredDataNodes[0]; // content/wysiwyg node of block
                                                if (blockContent.text.includes(oldCollege)) { // checking if content contains the old college name
                                                    blockContent.text = blockContent.text.replaceAll(oldCollege, newCollege); // if so, lets replace it
                                                    editAsset({
                                                        asset: result.apiReturn,
                                                    }).then(function(result) {
                                                        console.log(result);
                                                    }).catch(function(error) {
                                                        console.log(error);
                                                    });
                                                    // edit function updates the block
                                                }
                                            }).catch(function(error) {
                                                console.log(error);
                                            });
                                        }
                                    } else if (rowType.text && rowType.text == "WYSIWYG") {
                                        if (rowContent.text.includes(oldCollege)) { // checking if content contains the old college name
                                            rowContent.text = rowContent.text.replaceAll(oldCollege, newCollege); // if so, lets replace it
                                            updatedRows = true; // setting to true since we updated a row, maybe more then 1
                                        }
                                    }
                                }
                            });
                            if (updatedRows) { // if we updated rows, lets update the page 
                                editAsset({
                                    asset: result.apiReturn,
                                }).then(function(result) {
                                    console.log(result);
                                }).catch(function(error) {
                                    console.log(error);
                                });
                            }
                        }).catch(function(error) {
                            console.log(error);
                        });
                    }
                });
            }).catch(function(error) {
                console.log(error);
            });
        }
    </script>
</body>

</html>