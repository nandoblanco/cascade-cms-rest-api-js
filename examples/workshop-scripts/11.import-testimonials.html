<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>
    <script src="../../cascade-restapi.js"></script>
    <script>
        var baseAssetID = "8f6258adc0a8002f45f9e97a1c878dc4"; // fill in
        var testimonialsFolderPath = "blocks/testimonial"; // fill in
        var testimonialsSiteName = "CUC24-Web-Services-master"; // fill in

        // Papa Parse is a free JS library that makes reading CSV files super easy
        // https://www.papaparse.com

        Papa.parse('csv/testimonials.csv', {
            header: true,
            download: true,
            skipEmptyLines: true,
            transformHeader: function(h) {
                return h.replace(/[\W_]+/g, "").trim();
            },
            complete: function(result) {
                console.log(result);
                importTestimonials(result.data);
            }
        });

        function importTestimonials(data) {
            data.forEach(function(t) {
                // loop over the testimonials

                // console.log(t);
                // output each testimonial as an object

                // console.log(t.quote);
                // console.log(t.quotee);
                // console.log(t.year);
                // output each testimonial indiviual property/value

                var newBlockName = t.quotee.toLowerCase().replaceAll(/[^a-z0-9-]/gi, "-").trim();
                // format the testimonial quotee to the correct format needed for the block name 

                // console.log(newBlockName);
                // output newBlockName to verify its correct

                // copy block using asset path and folder path defined above
                // #1 first we copy
                copyAsset({
                    type: "block",
                    id: baseAssetID,
                    copyParameters: {
                        newName: newBlockName,
                        destinationContainerIdentifier: {
                            type: "folder",
                            path: {
                                path: testimonialsFolderPath,
                                siteName: testimonialsSiteName,
                            }
                        }
                    }
                }).then(function(result) {
                    console.log(result);
                    // #2 then we read
                    readAsset({
                        type: "block",
                        path: testimonialsFolderPath + "/" + newBlockName,
                        siteName: testimonialsSiteName,
                        // the copy operation does NOT return a new asset ID so we use the same global vars we used to create the copy to read the copy
                    }).then(function(result) {
                        console.log(result);
                        var testimonial = result.apiReturn.asset.xhtmlDataDefinitionBlock.structuredData.structuredDataNodes[0].structuredDataNodes;
                        testimonial[0].text = t.quote; // quote
                        testimonial[1].text = t.quotee; // quotee
                        testimonial[2].text = t.year; // year
                        // update the testimonial fields
                        editAsset({
                            asset: result.apiReturn,
                        }).then(function(result) {
                            console.log(result);
                        }).catch(function(error) {
                            console.log(error);
                        });
                        // using the edit fuction, we send back the edited object 
                    }).catch(function(error) {
                        console.log(error);
                    });
                }).catch(function(error) {
                    console.log(error);
                });
                // console.log("----");
                // a separator to make the log easy to read
            });
        }
    </script>
</body>

</html>